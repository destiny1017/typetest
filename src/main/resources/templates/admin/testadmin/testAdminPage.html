<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="personalities/fragments/header.html :: header">
    <meta charset="utf-8">
</head>
<body>
<div class="ta-container">
    <!--<div class="ta-title">
        <span class="">테스트 생성</span>
    </div>-->
    <div class="px-3 py-3 vstack testInfo-contents">
        <!-- 상단 tabs -->
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a id="step1" class="nav-link active" aria-current="page" href="#">STEP1</a>
            </li>
            <li class="nav-item">
                <a id="step2" class="nav-link" href="#">STEP2</a>
            </li>
            <li class="nav-item">
                <a id="step3" class="nav-link" href="#">STEP3</a>
            </li>
            <li class="nav-item">
                <a id="step4" class="nav-link">STEP4</a>
            </li>
        </ul>

        <!-- tab1 contents div-->
        <div id="step1Content" class="tab-contents active">
            <form method="get" action="/testAdmin/step1Submit" class="tab-contentsForm">
                <div class="select-div">
                    <div>
                        <label class="name-label">테스트 선택</label>
                    </div>
                    <select class="type-select form-select" onchange="location.href='/testAdminPage/' + this.value">
                        <option value="NEW">새로 만들기</option>
                        <option th:each="testInfo : ${testList}"
                                th:text="${testInfo.testName}" th:value="${testInfo.testCode}"
                                th:selected="${testCode} == ${testInfo.testCode}"></option>
                    </select>
                </div>
                <div class="testCode-div">
                    <div>
                        <label class="name-label">테스트 코드 입력</label>
                    </div>
                    <div class="testCode-text-div">
                        <input type="text" class="form-control" th:field="*{testInfoDto.testCode}" placeholder="테스트코드">
                        <div class="px-1"></div>
                        <input type="text" class="form-control" th:field="*{testInfoDto.testName}" placeholder="테스트이름">
                    </div>
                </div>
                <div class="answerType-div">
                    <div>
                        <label class="name-label">테스트 방식 선택</label>
                    </div>
                    <div class="answerType-content">
                        <div th:each="answerType : ${answerTypeList}" class="answerType-div">
                            <div class="answerType-title-div">
                                <input type="radio" class="form-check-input" th:field="*{testInfoDto.answerType}" th:value="${answerType}">
                                <label class="form-check-label" th:text="${answerType.getKrType()}" th:for="${#ids.prev('answerType')}"></label>
                            </div>
                            <div class="answerType-img-div">
                                <img class="answerType-img" th:src="${answerType.getImage()}">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="introImgUp-div">
                    <label class="name-label">테스트 메인 이미지</label>
                    <div>
                        <input type="text" class="form-control" th:field="*{testInfoDto.image}">
                    </div>
                </div>
                <div class="introDesc-div">
                    <label class="name-label">테스트 설명</label>
                    <div>
                        <textarea class="form-control" th:field="*{testInfoDto.description}"></textarea>
                    </div>
                </div>
                <div class="tabSubmit-div">
                    <button class="btn btn-primary" type="submit">저장</button>
                </div>
            </form>
        </div>

        <!-- tab2 contents div-->
        <div id="step2Content" class="tab-contents">
            <form method="get" action="/testAdmin/step2Submit" class="tab-contentsForm" th:object="${indicatorForm}" id="tab2Form">
                <input type="hidden" th:field="*{indicatorTestCode}">
                <div class="indicator-div" th:each="indicator : *{indicatorList}" th:id="|indicatorDiv${indicatorStat.index + 1}|">
                    <div class="indicator-title">
                        <p><span class="material-icons">edit</span>유형 지표 정보</p>
                        <span class="material-icons indicatorDelete" th:id="|indiDel${indicatorStat.index + 1}|">close</span>
                    </div>
                    <input type="hidden" th:field="*{indicatorList[__${indicatorStat.index}__].id}">
                    <div class="indicatorInfo-div">
                        <div class="indicatorElement-div">
                            <label>지표 번호</label>
                            <input type="text" class="form-control" th:field="*{indicatorList[__${indicatorStat.index}__].indicatorNum}"
                                   th:value="${indicator.indicatorNum}">
                        </div>
                        <div class="indicatorElement-div">
                            <label>지표 이름</label>
                            <input type="text" class="form-control" th:field="*{indicatorList[__${indicatorStat.index}__].indicatorName}"
                                   th:value="${indicator.indicatorName}">
                        </div>
                    </div>
                    <div class="setting-div">
                        <div th:each="indicatorSetting, stat : *{indicatorList[__${indicatorStat.index}__].indicatorSettings}"
                             class="settingInfo-div" th:id="|settingDiv-${indicatorStat.index + 1}-${stat.index}|">
                            <input type="hidden" th:field="*{indicatorList[__${indicatorStat.index}__].indicatorSettings[__${stat.index}__].id}">
                            <div class="settingElement-div">
                                <label>지표 코드</label>
                                <input type="text" class="form-control code-input"
                                       th:field="*{indicatorList[__${indicatorStat.index}__].indicatorSettings[__${stat.index}__].result}"
                                       th:value="${indicatorSetting.result}">
                            </div>
                            <div class="settingElement-div">
                                <label>지표 결정 점수</label>
                                <input type="text" class="form-control"
                                       th:field="*{indicatorList[__${indicatorStat.index}__].indicatorSettings[__${stat.index}__].cuttingPoint}"
                                       th:value="${indicatorSetting.cuttingPoint}">
                            </div>
                            <span class="material-icons delSetting" th:id="|delSetting-${indicatorStat.index + 1}-${stat.index}|"
                                  style="display: none;">
                                delete
                            </span>
                        </div>
                        <div class="settingAdd-div" th:id="|settingAdd-div-${indicatorStat.index + 1}|">
                            <span class="settingAdd" th:id="|settingAdd-${indicatorStat.index + 1}|">+ 지표 정보 추가</span>
                        </div>
                    </div>
                </div>
                <div class="addIndicator-div" id="addIndicator">
                    <div class="add-icon">
                        <p class="plus1"></p>
                        <p class="plus2"></p>
                    </div>
                </div>
                <div class="tabSubmit-div">
                    <button class="btn btn-primary" type="submit">저장</button>
                </div>
            </form>
        </div>

        <!-- tab3 contents div-->
        <div id="step3Content" class="tab-contents">
            <form method="get" action="/testAdmin/step3Submit" class="tab-contentsForm" th:object="${questionForm}" id="tab3Form">
                <input type="hidden" th:field="*{questionTestCode}">
                <div class="question-div" th:each="questionInfo : *{questionList}" th:id="|questionDiv${questionInfoStat.index + 1}|">
                    <div class="question-title">
                        <div>
                            <span class="material-icons">edit</span>
                            <input type="text" th:field="*{questionList[__${questionInfoStat.index}__].num}">
                            <input type="text" th:field="*{questionList[__${questionInfoStat.index}__].question}">
                        </div>
                        <span class="material-icons questionDelete" th:id="|questionDel${questionInfoStat.index + 1}|">close</span>
                    </div>
                    <div>
                        <input type="hidden" th:field="*{questionList[__${questionInfoStat.index}__].id}">
                        <div class="indicatorInfo-div">
                            <div class="indicatorElement-div">
                                <label>질문 이미지</label>
                                <input type="text" class="form-control" th:field="*{questionList[__${questionInfoStat.index}__].questionImage}">
                            </div>
                            <div class="indicatorElement-div">
                                <label>질문 내용</label>
                                <input type="text" class="form-control" th:field="*{questionList[__${questionInfoStat.index}__].question}">
                            </div>
                        </div>
                        <div class="answer-div">
                            <div th:each="answer, stat : *{questionList[__${questionInfoStat.index}__].answerList}"
                                 class="answerInfo-div" th:id="|answerDiv-${questionInfoStat.index + 1}-${stat.index}|">
                                <input type="hidden" th:field="*{questionList[__${questionInfoStat.index}__].answerList[__${stat.index}__].id}">
                                <div class="answerElement-div">
                                    <label>답변 이미지</label>
                                    <input type="text" class="form-control code-input"
                                           th:field="*{questionList[__${questionInfoStat.index}__].answerList[__${stat.index}__].answerImage}">
                                </div>
                                <div class="answerElement-div">
                                    <label>답변 내용</label>
                                    <input type="text" class="form-control"
                                           th:field="*{questionList[__${questionInfoStat.index}__].answerList[__${stat.index}__].answer}">
                                </div>
                                <div class="answerElement-div">
                                    <label>답변 점수</label>
                                    <input type="text" class="form-control"
                                           th:field="*{questionList[__${questionInfoStat.index}__].answerList[__${stat.index}__].point}">
                                </div>
                                <div class="answerElement-div">
                                    <label>답변 지표</label>
                                    <select class="answer-select form-select">
                                        <option th:each="indicator : ${indicatorForm.indicatorList}"
                                                th:text="${indicator.indicatorName}" th:value="${indicator.id}"
                                                th:selected="${indicator.id} == *{questionList[__${questionInfoStat.index}__].answerList[__${stat.index}__].typeIndicator.id}"></option>
                                    </select>
                                </div>
                                <div class="answerElement-div">
                                    <label>답변 성향</label>
                                    <select class="answer-select form-select">
                                        <option th:each="tendency : ${tendencyList}"
                                                th:text="${tendency.getFullName()}" th:value="${tendency}"
                                                th:selected="${tendency} == *{questionList[__${questionInfoStat.index}__].answerList[__${stat.index}__].tendency}"></option>
                                    </select>
                                </div>
                                <!--<span class="material-icons delSetting" th:id="|delSetting-${indicatorStat.index + 1}-${stat.index}|"
                                      style="display: none;">
                                    delete
                                </span>-->
                            </div>
                            <div class="answerAdd-div" th:id="|answerAdd-div-${questionInfoStat.index + 1}|">
                                <span class="answerAdd" th:id="|answerAdd-${questionInfoStat.index + 1}|">+ 답변 정보 추가</span>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div id="step4Content" class="tab-contents">

        </div>
    </div>
    <footer th:replace="personalities/fragments/footer.html :: footer"></footer>
    
    <script th:inline="javascript">
    console.log("we");
    const indicatorList = [[${indicatorForm.indicatorList}]];

    $(document).ready( () => {
        
        /**
         *  클릭 이벤트 연결
         */
        
        // tab클릭 시 내용 전환 이벤트
        $(".nav-link").click( (e) => {
            $('[id^="step"]').removeClass("active");
            $(`[id^="${e.target.id}"]`).addClass("active");
        });

        // indicator 추가 클릭
        $("#addIndicator").click( () => {
            indicatorAddEvent();
        });

        // setting 추가 클릭
        $(".settingAdd").click( (e) => {
            settingAddEvent(e);
        });

        // indicator 삭제 클릭
        $(".indicatorDelete").click( (e) => {
            indicatorDeleteEvent(e);
        });

        // setting 삭제 클릭
        $(".delSetting").click( (e) => {
            settingDeleteEvent(e);
        });

        // setting 삭제아이콘 hover시에만 나타나도록
        $(".settingInfo-div").hover( (e) => {
            settingInfoHoverInEvent(e);
        }, (e) => {
            settingInfoHoverOutEvent(e);
        });
        
        

        function indicatorDeleteEvent(e) {
            let targetNum = e.target.id.replace("indiDelTmp", "");
            $("#indicatorDiv" + targetNum).hide();
            $("#indicatorDiv" + targetNum + ' input:not([type="hidden"])').val("");
        };

        function settingDeleteEvent(e) {
            let targetNum = e.target.id.replace("delSetting", "");
            $("#settingDiv" + targetNum).hide();
            $("#settingDiv" + targetNum + ' input:not([type="hidden"])').val("");
        };

        function settingInfoHoverInEvent(e) {
            let targetId = e.currentTarget.id.replace("settingDiv", "");
            $("#delSetting" + targetId).show();
        }

        function settingInfoHoverOutEvent(e) {
            let targetId = e.currentTarget.id.replace("settingDiv", "");
            $("#delSetting" + targetId).hide();
        }
        
        function indicatorAddEvent() {
            // 새롭게 추가될 indicatorDiv 내용
            let indicatorDiv =
            `
                <div class="indicator-div" id="indicatorDiv${indicatorList.length + 1}">
                    <div class="indicator-title">
                        <p><span class="material-icons">edit</span>유형 지표 정보</p>
                        <span class="material-icons indicatorDelete" id="indiDelTmp${indicatorList.length + 1}">close</span>
                    </div>
                    <div class="indicatorInfo-div">
                        <div class="indicatorElement-div">
                            <label>지표 번호</label>
                            <input type="text" class="form-control" name="indicatorList[${indicatorList.length}].indicatorNum">
                        </div>
                        <div>
                            <label>지표 이름</label>
                            <input type="text" class="form-control" name="indicatorList[${indicatorList.length}].indicatorName">
                        </div>
                    </div>
                    <div class="setting-div">
                        <div class="settingAdd-div" id="settingAdd-div-${indicatorList.length + 1}">
                            <span class="settingAdd" id="settingAdd-${indicatorList.length + 1}">+ 지표 정보 추가</span>
                        </div>
                    </div>
                </div>
            `;
            // 추가버튼 위에 새 div 추가
            $("#addIndicator").before(indicatorDiv);
            
            // 요소 개수 카운트를 위해 indicator배열에 빈 객체 추가
            indicatorList.push({indicatorSettings:[]});

            // 추가된 indicator 삭제버튼에 이벤트 연결
            $("#indiDelTmp" + (indicatorList.length)).click( (e) => {
                indicatorDeleteEvent(e);
            });

            // 추가된 setting추가 버튼에 이벤트 연결
            $("#settingAdd-" + (indicatorList.length)).click( (e) => {
                settingAddEvent(e);
            });
        }

        function settingAddEvent(e) {
            // 새롭게 추가될 setting div 내용
            let targetNum = e.target.id.replace("settingAdd-", "");
            let settingDiv =
            `
                <div class="settingInfo-div"
                    id="settingDiv-${targetNum}-${indicatorList[targetNum-1].indicatorSettings.length}">
                    <div class="settingElement-div">
                        <label>지표 코드</label>
                        <input type="text" class="form-control code-input"
                            name="indicatorList[${targetNum - 1}].indicatorSettings[${indicatorList[targetNum-1].indicatorSettings.length}].result">
                    </div>
                    <div class="settingElement-div">
                        <label>지표 결정 점수</label>
                        <input type="text" class="form-control"
                            name="indicatorList[${targetNum - 1}].indicatorSettings[${indicatorList[targetNum-1].indicatorSettings.length}].cuttingPoint">
                    </div>
                    <span class="material-icons delSetting" id="delSetting-${targetNum}-${indicatorList[targetNum-1].indicatorSettings.length}"
                            style="display: none;">
                        delete
                    </span>
                </div>
            `;
            // 추가버튼 위에 div 추가
            $("#settingAdd-div-" + targetNum).before(settingDiv);
            
            // 데이터 카운트를 위해 빈 객체 추가
            indicatorList[targetNum - 1].indicatorSettings.push({});

            // 추가된 삭제버튼에 삭제 이벤트 연결
            $(`#delSetting-${targetNum}-${indicatorList[targetNum-1].indicatorSettings.length - 1}`).click( (e) => {
                settingDeleteEvent(e);
            });

            // 추가된 삭제버튼에 hover 이벤트 연결
            $(`#settingDiv-${targetNum}-${indicatorList[targetNum-1].indicatorSettings.length - 1}`).hover( (e) => {
                settingInfoHoverInEvent(e);
            }, (e) => {
                settingInfoHoverOutEvent(e);
            });
        }

    });
</script>
</div>
</body>
</html>


