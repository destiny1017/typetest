<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PersonalityTestServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">typetest</a> &gt; <a href="index.source.html" class="el_package">com.typetest.personalities.service</a> &gt; <span class="el_source">PersonalityTestServiceImpl.java</span></div><h1>PersonalityTestServiceImpl.java</h1><pre class="source lang-java linenums">package com.typetest.personalities.service;

import com.typetest.exception.NotFoundEntityException;
import com.typetest.user.domain.User;
import com.typetest.user.repository.UserRepository;
import com.typetest.personalities.data.AnswerType;
import com.typetest.personalities.data.TestResultDto;
import com.typetest.personalities.domain.*;
import com.typetest.personalities.data.PersonalitiesAnswerInfo;
import com.typetest.personalities.data.ExamQuestionDto;
import com.typetest.personalities.repository.*;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Primary;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.stereotype.Service;

import java.text.DecimalFormat;
import java.util.*;

@Service
@RequiredArgsConstructor
@Primary
public class PersonalityTestServiceImpl implements PersonalityTestService {

    private final TestResultRepository testResultRepository;
    private final TestResultDetailRepository testResultDetailRepository;
    private final LoginRepository loginRepository;
    private final TypeInfoRepository typeInfoRepository;
    private final IndicatorSettingRepository indicatorSettingRepository;
    private final PersonalityAnswerRepository personalityAnswerRepository;
    private final TestCodeInfoRepository testCodeInfoRepository;
    private final PersonalityQuestionRepository personalityQuestionRepository;

    @Override
    public List getQuestions(String testCode) {
<span class="fc" id="L37">        Optional&lt;TestCodeInfo&gt; testCodeInfoOp = testCodeInfoRepository.findById(testCode);</span>
<span class="pc bpc" id="L38" title="1 of 2 branches missed.">        if(testCodeInfoOp.isPresent()) {</span>
<span class="fc" id="L39">            TestCodeInfo testCodeInfo = testCodeInfoOp.get();</span>
<span class="fc" id="L40">            List&lt;PersonalityQuestion&gt; questions = personalityQuestionRepository.findByTestCode(testCodeInfo);</span>
<span class="fc bfc" id="L41" title="All 2 branches covered.">            if(testCodeInfo.getAnswerType() == AnswerType.EXAM) {</span>
<span class="fc" id="L42">                List&lt;List&lt;ExamQuestionDto&gt;&gt; pageQuestions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L43">                int cnt = -1;</span>
<span class="fc bfc" id="L44" title="All 2 branches covered.">                for (int i = 0; i &lt; questions.size(); i++) {</span>
<span class="fc bfc" id="L45" title="All 2 branches covered.">                    if((i) % 10 == 0) {</span>
<span class="fc" id="L46">                        pageQuestions.add(new ArrayList&lt;&gt;());</span>
<span class="fc" id="L47">                        cnt++; // 10개 추가될 때 마다 다음 인덱스에 담기</span>
                    }
<span class="fc" id="L49">                    pageQuestions.get(cnt).add(new ExamQuestionDto(questions.get(i)));</span>
                }
<span class="fc" id="L51">                return pageQuestions;</span>
<span class="pc bpc" id="L52" title="1 of 2 branches missed.">            } else if(testCodeInfo.getAnswerType() == AnswerType.CARD) {</span>
<span class="fc" id="L53">                List&lt;ExamQuestionDto&gt; questionDtos = new ArrayList&lt;&gt;();</span>
<span class="pc" id="L54">                questions.stream().forEach(i -&gt; questionDtos.add(new ExamQuestionDto(i)));</span>
<span class="fc" id="L55">                return questionDtos;</span>
            }
<span class="nc" id="L57">            return null;</span>
        } else {
<span class="nc" id="L59">            throw new NotFoundEntityException(&quot;테스트코드 [&quot; + testCode + &quot;] 에 해당하는 테스트정보를 찾을 수 없습니다.&quot;);</span>
        }
    }

    @Override
    public Page&lt;ExamQuestionDto&gt; getQuestionsPage(String testCode) {
<span class="nc" id="L65">        Optional&lt;TestCodeInfo&gt; testCodeInfoOp = testCodeInfoRepository.findById(testCode);</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">        if(testCodeInfoOp.isPresent()) {</span>
<span class="nc" id="L67">            Page&lt;ExamQuestionDto&gt; questions = personalityQuestionRepository.findByTestCode(testCodeInfoOp.get(), PageRequest.of(0, 10));</span>
<span class="nc" id="L68">            return questions;</span>
        } else {
<span class="nc" id="L70">            throw new NotFoundEntityException(&quot;테스트코드 [&quot; + testCode + &quot;] 에 해당하는 질문데이터를 찾을 수 없습니다.&quot;);</span>
        }
    }

    @Override
    public Long getQuestionCnt(String testCode) {
<span class="fc" id="L76">        Optional&lt;TestCodeInfo&gt; testCodeInfoOp = testCodeInfoRepository.findById(testCode);</span>
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">        if (testCodeInfoOp.isPresent()) {</span>
<span class="fc" id="L78">            return personalityQuestionRepository.countByTestCode(testCodeInfoOp.get());</span>
        } else {
<span class="nc" id="L80">            throw new NotFoundEntityException(&quot;테스트코드 [&quot; + testCode + &quot;] 에 해당하는 테스트정보를 찾을 수 없습니다.&quot;);</span>
        }
    }

    @Override
    public String calcType(PersonalitiesAnswerInfo answerInfo) {
<span class="fc" id="L86">        HashMap&lt;Integer, Long&gt; answer = answerInfo.getAnswer();</span>
<span class="fc" id="L87">        List&lt;PersonalityAnswer&gt; answerList = personalityAnswerRepository.findByIdIn(answer.values());</span>
<span class="fc" id="L88">        Map&lt;TypeIndicator, Integer&gt; pointMap = new LinkedHashMap&lt;&gt;();</span>
<span class="fc" id="L89">        StringBuffer type = new StringBuffer();</span>

        // 응답받은 답변 엔티티들의 점수 합산
<span class="fc" id="L92">        answerList.stream().forEach(selectedAnswer -&gt;</span>
                // 선택한 답변에 해당하는 indicator를 key로, 선택한 답변의 point를 value로
<span class="fc" id="L94">                pointMap.put(selectedAnswer.getTypeIndicator(),</span>
<span class="fc" id="L95">                        pointMap.getOrDefault(selectedAnswer.getTypeIndicator(), 0) + selectedAnswer.getPoint()));</span>

        // result 하나만 받아올 pageRequest
<span class="fc" id="L98">        PageRequest pr = PageRequest.of(0, 1);</span>

        // indicator별 결과를 type에 차례대로 append
<span class="fc" id="L101">        pointMap.forEach((indicator, point) -&gt;</span>
<span class="fc" id="L102">                type.append(indicatorSettingRepository</span>
<span class="fc" id="L103">                        .findByTypeIndicatorAndCuttingPointLessThanOrderByCuttingPointDesc(indicator, point, pr)</span>
<span class="fc" id="L104">                        .get(0).getResult()));</span>

<span class="fc" id="L106">        return type.toString();</span>
    }

    @Override
    public void saveTestInfo(PersonalitiesAnswerInfo answerInfo, String type) throws NotFoundEntityException {
<span class="fc" id="L111">        Long userId = answerInfo.getUserId();</span>
<span class="fc" id="L112">        TestCodeInfo testCode = answerInfo.getTestCodeInfo();</span>
<span class="fc" id="L113">        Map&lt;Integer, Long&gt; answer = answerInfo.getAnswer();</span>
<span class="fc" id="L114">        Optional&lt;User&gt; byId = loginRepository.findById(userId);</span>
        User user;
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">        if(byId.isPresent()) {</span>
<span class="fc" id="L117">            user = byId.get();</span>
<span class="fc" id="L118">            Optional&lt;TypeInfo&gt; typeInfo = typeInfoRepository.findByTestCodeAndTypeCode(testCode, type);</span>
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">            if(typeInfo.isPresent()) {</span>
<span class="fc" id="L120">                TestResult pt = new TestResult(user, testCode, typeInfo.get());</span>
<span class="fc" id="L121">                testResultRepository.save(pt); // 유형정보 저장</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">                for (int key : answer.keySet()) {</span>
<span class="fc" id="L123">                    Optional&lt;PersonalityAnswer&gt; findAnswer = personalityAnswerRepository.findById(answer.get(key));</span>
<span class="fc" id="L124">                    TestResultDetail ptd = new TestResultDetail(pt, user, testCode, key, findAnswer.get());</span>
<span class="fc" id="L125">                    testResultDetailRepository.save(ptd); // 테스트 상세 응답 정보 저장</span>
<span class="fc" id="L126">                }</span>
<span class="fc" id="L127">            } else {</span>
<span class="nc" id="L128">                throw new NotFoundEntityException(&quot;[&quot; + type + &quot;] 에 해당하는 유형정보를 찾을 수 없습니다.&quot;);</span>
            }
<span class="fc" id="L130">        } else {</span>
<span class="nc" id="L131">            throw new NotFoundEntityException(&quot;[&quot; + userId + &quot;] 사용자를 찾을 수 없습니다.&quot;);</span>
        }

<span class="fc" id="L134">    }</span>

    @Override
    public TestResultDto createTestResultInfo(String testCode, String type) {
<span class="fc" id="L138">        Optional&lt;TestCodeInfo&gt; testCodeInfo = testCodeInfoRepository.findById(testCode);</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">        if(testCodeInfo.isPresent()) {</span>
<span class="fc" id="L140">            Optional&lt;TypeInfo&gt; typeInfo = typeInfoRepository.findByTestCodeAndTypeCode(testCodeInfo.get(), type);</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">            if(typeInfo.isPresent()) {</span>
<span class="fc" id="L142">                TestResultDto testResultDto = new TestResultDto(typeInfo.get());</span>
<span class="fc" id="L143">                double rate = ((double) typeInfo.get().getResultCount() / testCodeInfo.get().getPlayCount());</span>
<span class="fc" id="L144">                testResultDto.setTypeRate(new DecimalFormat(&quot;#.#%&quot;).format(rate));</span>
<span class="fc" id="L145">                return testResultDto;</span>
            } else {
<span class="nc" id="L147">                throw new NotFoundEntityException(&quot;[&quot; + testCode + &quot;] 에 해당하는 테스트 정보를 찾을 수 없습니다.&quot;);</span>
            }
        } else {
<span class="nc" id="L150">            throw new NotFoundEntityException(&quot;[&quot; + type + &quot;] 에 해당하는 유형정보를 찾을 수 없습니다.&quot;);</span>
        }
    }

    @Override
    public void plusResultCount(TestCodeInfo testCodeInfo, String type) {
<span class="fc" id="L156">        Optional&lt;TypeInfo&gt; typeInfoOp = typeInfoRepository.findByTestCodeAndTypeCode(testCodeInfo, type);</span>
<span class="fc" id="L157">        testCodeInfoRepository.plusPlayCount(testCodeInfo);</span>

<span class="pc bpc" id="L159" title="1 of 2 branches missed.">        if (typeInfoOp.isPresent()) {</span>
<span class="fc" id="L160">            TypeInfo typeInfo = typeInfoOp.get();</span>
<span class="fc" id="L161">            typeInfoRepository.plusResultCount(typeInfo);</span>
<span class="fc" id="L162">        } else {</span>
<span class="nc" id="L163">            throw new NotFoundEntityException(&quot;[&quot; + type + &quot;] 에 해당하는 유형정보를 찾을 수 없습니다.&quot;);</span>
        }

<span class="fc" id="L166">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>